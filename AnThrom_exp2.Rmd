---
title: "Exploring the relationship between anthropomorphism and Theory-of-Mind in brain and behaviour: Experiment 2"
author: Ruud Hortensius and Michaela Kent
output:
  html_document:
    df_print: paged
    toc: yes
    toc_float: yes
    code_folding: show
  html_notebook:
    number_sections: no
    theme: default
    toc: yes
    toc_float: yes
    code_folding: show
editor_options: 
  chunk_output_type: inline
---
Testing the relationship between situational and dispositional anthropomorphism and Theory-of-Mind   
June 2020 - July 2020

# 1. Details {.tabset .tabset-fade .tabset-pills}

## 1.1 Preregistration
The preregistration can be found here: [link]

## 1.2 Libraries
```{r, message=FALSE}
source("R_rainclouds.R") 
source("summarySE.R")
library(psych)
library(patchwork)
library(tidyverse)
library(kableExtra)
library(ordinal)
library(brms)
library(easystats) #devtools::install_github("easystats/easystats")
library(sjPlot)
library(httr)
library(waffle) #devtools::install_github("hrbrmstr/waffle")
options(mc.cores = parallel::detectCores()) 
theme_set(theme_classic(base_size = 10)) 
options("scipen"=10, "digits"=4) 

```

## 1.3 Data description
This Rmd is written based on pilot data (target sample size of n = 20). 

# 2. Load the data {.tabset .tabset-fade .tabset-pills}
The data can be downloaded from the [OSF project page](https://osf.io/a8pyr/)

## 2.1 Load the prolific export file
Post-preregistration note: only information from the approved participants that completed all parts of the experiment are included, as returned and timed out participant don't necessarily provide consent ([explainer on Prolific:](https://researcher-help.prolific.co/hc/en-gb/articles/360009259434-Returned-submission-status) 
```{r, echo = TRUE, message = FALSE}
DF.demo <- list.files("experiment2/data/main",pattern="\\prolific*", full.names=TRUE) %>% #change to "experiment2/data/main"
  map_dfr(read_csv)

demo_sub <- DF.demo %>% select(participant_id) %>% unique()

```

## 2.2 Load the psychopy/pavlovia files
```{r, echo = TRUE, message = FALSE}
DF.exp2 <- list.files("experiment2/data/main",pattern="\\PARTICIPANT*", full.names=TRUE) %>% 
  map_dfr(read_csv) %>% 
  rename(participant_id = prolific_id) %>%
  filter(participant_id %in% DF.demo$participant_id)
#events <- read_csv("experiment2/events_pilot.csv") #can be removed for main experiment, corrected in psychopy
```

## 2.3 Get the rating task data

-After each of the 16 “mental” or “pain” scenes, we will pause the film and will ask the participant to rate the extent to which they believe the characters of the film (a stork and a cloud) possess certain capacities. Participants rate if the character is able to “choose and control its own actions”, “be aware of itself and its thoughts and feelings”, “do what it wants”, and whether the character has “preferences and plans” and “feelings” on a scale from 1 (not at all) to 7 (very much). These items correspond to the definitions used by Waytz and colleagues (2010; 2018) for “free will”, “consciousness”, “a mind of its own”, “intentions”, and the “experience emotions”. 

-After each of the 16 “mental” or “pain” scenes, we will pause the film and participants will be asked to what extent they feel capable of “imagining what the cloud will do next” and “thinking about what the cloud is doing and why” on a scale from 1 (not at all) to 7 (very much). These items correspond to the definitions used for “understood the character” and “feel capable of predicting it’s future behaviour” in the study of Waytz, Morewedge and colleagues (2010).  A 7-point scale instead of a 10-point scale is used to allow for presentation alongside the situational anthropomorphism items. 

```{r}
DF.rating <- DF.exp2 %>%
  select("participant_id", "eventnr","event_type", "measure", "item", "focus", "key_resp_1.keys", "key_resp_2.keys", "key_resp_1.rt", "key_resp_2.rt")  %>%
  mutate_at(vars(-key_resp_1.keys, -key_resp_2.keys, -key_resp_1.rt, -key_resp_2.rt),as.factor) %>%
  mutate(response = coalesce(key_resp_1.keys, key_resp_2.keys)) %>%
  mutate(rt = coalesce(key_resp_1.rt, key_resp_2.rt)) %>%
  select(-key_resp_1.keys, -key_resp_2.keys,-key_resp_1.rt, -key_resp_2.rt) %>%
  filter(!is.na(response) & !is.na(focus)) %>%
  dplyr::group_by(participant_id) %>%
  #mutate(trial_nr = c(1:length(response))) %>% #can be removed for main experiment, corrected in psychopy
  #select(-event_typeM, -eventnrM) %>% #can be removed for main experiment, corrected in psychopy
  #left_join(., events, by = "trial_nr") %>% #can be removed for main experiment, corrected in psychopy
  mutate_at(vars(-response, -rt),as.factor) 
```

## 2.4 Get the IDAQ task data
Participants will be asked to complete the Individual Differences in Anthropomorphism Questionnaire (IDAQ; Waytz, Cacioppo, et al., 2010) at the end of the study. This questionnaire consists of 15 anthropomorphic items for which participants provide a rating on the extent that natural entities, non-human animals, and technological devices have “free will”, “consciousness”, “a mind of its own”, “intentions”, and can “experience emotions”. The questionnaire has 15 additional nonanthropomorphic items (IDAQ-NA) for which participants provide a rating of functional features of a stimulus (good-looking, active, useful, lethargic, durable; e.g. to what extent is the average camera lethargic?). Responses are rated on a scale from 0 (not at all) to 10 (very much). 

```{r}
DF.idaq <- DF.exp2 %>%
    select("participant_id", "ItemNr", "Question", "Scale",  "idaq_s.rt" , "idaq_s.response", "idaqs.rt" , "idaqs.response", "key_resp_8.rt", "key_resp_12.rt") %>%
  mutate(idaq_resp = coalesce(idaq_s.response, idaqs.response)) %>%
  mutate(idaq_rt = coalesce(idaq_s.rt, idaqs.rt, key_resp_8.rt, key_resp_12.rt)) %>%
  filter(!is.na(idaq_rt)) %>%
  select(-idaq_s.rt, -idaq_s.response, -idaqs.rt, -idaqs.response, -key_resp_8.rt, -key_resp_12.rt)
```

## 2.5 Get the false belief task data
Participants will be asked to indicate if a short statement about the false-belief or false-photograph story is true (1) or false (2). 
```{r}
DF.fa <- DF.exp2 %>%
  select("participant_id", "p_b", "trials_fb.thisIndex",  "key_resp_fb.keys" , "key_resp_fb.rt", "CorrectAns")  %>%
  rename(fa_resp = key_resp_fb.keys, item_number = trials_fb.thisIndex, rt = key_resp_fb.rt) %>%
  filter(!is.na(p_b)) %>%
  mutate(acc = ifelse(fa_resp == CorrectAns, 1, 0)) %>%
  mutate_at(vars(-acc, -rt),as.factor) 
```

## 2.5 Get the control data
After 4:02 minutes the film will be paused, and participants will be asked to describe in one or two sentences what they think will happen next (to a maximum of 2000 characters including spaces). This serves as an attention check and a future exploratory measure.

```{r}
DF.prediction <- DF.exp2 %>%
  select("participant_id", "prediction", "key_resp_6.keys") %>%
  filter(!is.na(key_resp_6.keys)) %>%
  select(-key_resp_6.keys)
```

Participants will be asked to indicate if they have seen the film before (1-yes, 2-no).
```{r}
DF.seen <- DF.exp2 %>%
  select("participant_id", "key_resp_seen.keys") %>%
  rename(seen = key_resp_seen.keys) %>%
  filter(!is.na(seen)) 
```

# 3. Sample {.tabset .tabset-fade .tabset-pills}

## 3.1 Number of approved participants
```{r}
DF.demo %>% 
  dplyr::group_by(status) %>%
  tally() %>%
  knitr::kable(., "html", caption = "Breakdown prolific") %>%
  kable_styling("striped")
```

## 3.2 Age
```{r}
DF.demo %>% 
  mutate(age_bin = cut(age, breaks = c(18, 27, 37, 47, 57, 99), labels = c("18-27","28-37","38-47","48-57","58+"))) %>% 
  dplyr::group_by(age_bin) %>% 
  dplyr::summarise(
    n = n()) %>%
  knitr::kable(., "html", caption = "Age") %>%
  kable_styling("striped")
```

## 3.3 Male/female
```{r}
DF.demo %>% 
  dplyr::group_by(Sex) %>%
  tally() %>%
  knitr::kable(., "html", caption = "Sex") %>%
  kable_styling("striped")
```

## 3.4 Ethnicity
```{r}
DF.demo %>% 
  dplyr::group_by(`Ethnicity (Simplified)`) %>% 
  dplyr::summarise(n = n()) %>%
  knitr::kable(., "html", caption = "Ethnicity") %>%
  kable_styling("striped")
```

## 3.5 Detailed breakdown of demographics
```{r}
s1 <- DF.demo %>% 
  mutate(age_bin = cut(age, breaks = c(18, 27, 37, 47, 57, 99), 
                       labels = c("18-27","28-37","38-47","48-57","58+"))) %>% 
  filter(!is.na(age)) %>% 
  dplyr::group_by(Sex, `Ethnicity (Simplified)`, age_bin) %>% 
  dplyr::summarise(
    n = n()) %>%
  ggplot(aes(fill = Sex, values = n)) +
  geom_waffle(size = 0.33, colour = "white", flip = TRUE) +
  coord_equal() +
  theme_enhance_waffle() +
  theme(panel.grid = element_blank(), axis.ticks = element_blank(), axis.line = element_blank()) +
  facet_wrap(~age_bin, ncol = 5) +
  scale_fill_manual(values = c("#a40000", "#000666")) +
  theme_enhance_waffle()
s1

ggsave("experiment2/figures/S1.TIFF", plot = s1, width = 24.7, height = 5.08, units = "cm", dpi = 300)

```

```{r}
s2 <- DF.demo %>% 
  mutate(age_bin = cut(age, breaks = c(18, 27, 37, 47, 57, 99), 
                       labels = c("18-27","28-37","38-47","48-57","58+"))) %>% 
  filter(!is.na(age)) %>% 
  dplyr::group_by(`Ethnicity (Simplified)`, Sex, age_bin) %>% 
  dplyr::summarise(
    n = n()) %>%
  ggplot(aes(values = n, fill=`Ethnicity (Simplified)`))  +
  geom_waffle(size = 0.33, colour = "white", flip = TRUE) +
  coord_equal() +
  theme_enhance_waffle() +
  theme(panel.grid = element_blank(), axis.ticks = element_blank(), axis.line = element_blank()) +
  facet_wrap(Sex~age_bin, ncol = 5) +
  scale_fill_manual(values = c("#cc0033", "#FF00CC", "#660066", "#9900FF", "#3300CC")) +
  theme_enhance_waffle()
s2

ggsave("experiment2/figures/S2.TIFF", plot = s2, width = 24.7, height = 7, units = "cm", dpi = 300)

```


# 4. Data exclusion {.tabset .tabset-fade .tabset-pills}
The following criteria are used to exclude participants:

## 4.1 Attention check
Participants who fail the attention check, i.e. participant who do not make a prediction during the movie (no characters typed);

The following participant contacted us and indicated they pressed enter by mistake (there is no moving back option), we will not exclude this participant for not providing an answer (and 'failing' the attention check):

    5efcbd96e3b6fa0b354cbf2a

```{r}
excluded_participants <- DF.prediction %>% 
  filter(is.na(prediction) & participant_id != "5efcbd96e3b6fa0b354cbf2a") %>% 
  select(participant_id) %>% 
  mutate(reason = "attention_check")
```

## 4.2 No variability in ratings
Participants who show no variability in their ratings across the event numbers of the film, i.e. a standard deviation of <0.5;

```{r}
DF.rating %>%
  dplyr::group_by(participant_id, measure) %>%
  dplyr::summarise(ratingSD = sd(response)) %>%
  ggplot(., aes(x=measure, y=ratingSD, fill = measure)) +
  geom_point(aes(colour = measure), position=position_jitter(width = .02), size = 1, shape = 21, colour = "Black") +
  geom_boxplot(aes(x=measure,y=ratingSD),position=position_nudge(x = .1, y = 0),outlier.shape = NA, alpha = .5, width = .1, colour = "black") +
  geom_hline(yintercept = 0.5, color = "grey", linetype = 2) +
  annotate("text", x = 0.75, y = 0.6, label = "Preregistered exclusion criteria") +
  ylab("Standard deviation rating")+
  xlab("measure") +
  ggtitle("Variability of ratings during the rating task") +
  ylim(0,4)+
  scale_fill_manual(values=c("#0072B2", "#D55E00")) +
  theme(legend.position="none") 
```

Update the exclude participants list:
```{r}
excluded_participants <- DF.rating %>%
  dplyr::group_by(participant_id, measure) %>%
  dplyr::summarise(ratingSD = sd(response)) %>%
  filter(ratingSD < 0.5) %>% #should be < not <= 
  select(participant_id, ratingSD) %>%
  mutate(reason = "variability_rating") %>%
  bind_rows(., excluded_participants)
```

## 4.3 Click through
Participants who click through the rating task, i.e. with a mean response duration < 1sec:
```{r}
ctR <- DF.rating %>%
  dplyr::group_by(participant_id) %>%
  dplyr::summarise(rt = mean(rt)) %>%
  ggplot(., aes(x=1, y=rt, fill = "blue")) +
  geom_point(position=position_jitter(width = .02), size = 1, shape = 21, colour = "Black") +
  geom_boxplot(aes(x=1,y=rt),position=position_nudge(x = .1, y = 0),outlier.shape = NA, alpha = .5, width = .1, colour = "black") +
  geom_hline(yintercept = 1, color = "grey", linetype = 2) +
  annotate("text", x = 1.04, y = 1.15, label = "Preregistered exclusion criteria") +
  ylab("Mean reaction time")+
  xlab("measure") +
  ggtitle("Reaction time during the rating task") +
  scale_fill_manual(values=c("#0072B2", "#D55E00")) +
  theme(legend.position="none",     
        axis.text.x = element_blank(),     
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank()) 
```

Participants who click through the IDAQ questionnaire, i.e. with total duration of < 1min; 
```{r}
ctI <-DF.idaq %>%
  dplyr::group_by(participant_id) %>%
  dplyr::summarise(total = sum(idaq_rt)) %>%
  ggplot(., aes(x=1, y=total, fill = "blue")) +
  geom_point( position=position_jitter(width = .02), size = 1, shape = 21, colour = "Black") +
  geom_boxplot(aes(x=1,y=total),position=position_nudge(x = .1, y = 0),outlier.shape = NA, alpha = .5, width = .1, colour = "black") +
  geom_hline(yintercept = 60, color = "grey", linetype = 2) +
  #annotate("text", x = 1.0002, y = 70, label = "Preregistered exclusion criteria") +
  ylab("Mean completion time (sec)")+
  ggtitle("IDAQ completion time") +
    scale_fill_manual(values=c("#0072B2", "#D55E00")) +
  theme(legend.position="none",     
        axis.text.x = element_blank(),     
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank()) 
 
ctR + ctI
```

Update the exclude participants list (rating task):
```{r}
excluded_participants <- DF.rating %>%
  dplyr::group_by(participant_id) %>% #removed the measure (as in plot), was included by mistake
  dplyr::summarise(rt = mean(rt))  %>%
  filter(rt < 1) %>%
  select(participant_id, rt) %>%
  mutate(reason = "duration_rating") %>%
  bind_rows(., excluded_participants)
```

Update the exclude participants list (IDAQ):
```{r}
excluded_participants <- DF.idaq %>%
  dplyr::group_by(participant_id) %>%
  dplyr::summarise(total = sum(idaq_rt))  %>%
  filter(total < 60) %>%
  select(participant_id, total) %>%
  mutate(reason = "duration_idaq") %>%
  bind_rows(., excluded_participants)
```

## 4.4 Accuracy
Participants who have an accuracy of 50% or lower for the false belief questions in the False Belief task;
```{r}
DF.fa %>%
  dplyr::group_by(participant_id, p_b) %>%
  dplyr::summarise(acc = mean(acc, na.rm = TRUE)) %>% #na.rm was missing
  mutate_at(vars(-acc), as.factor) %>%
  ggplot(., aes(x=p_b, y=acc, fill = p_b)) +
  geom_point(aes(colour = p_b), position=position_jitter(width = .05), size = 1, shape = 21, colour = "Black") +
  geom_boxplot(aes(x=p_b,y=acc),position=position_nudge(x = .1, y = 0),outlier.shape = NA, alpha = .5, width = .1, colour = "black")+
  ylab("accuracy (p)")+
  xlab("belief (b) or photograph (p)") +
  geom_hline(yintercept = 0.5, color = "grey", linetype = 2) +
  annotate("text", x = 1, y = 0.53, label = "Preregistered exclusion criteria (false belief questions)") +
  scale_fill_manual(values=c("#0072B2", "#D55E00")) +
  theme(legend.position="none") +
  ylim(0, 1.3)
```

Update the exclude participants list:
```{r, eval=FALSE}
excluded_participants <- DF.fa %>%
  dplyr::group_by(participant_id, p_b) %>%
  dplyr::summarise(acc = mean(acc, na.rm = TRUE)) %>% #na.rm was missing
  filter(acc <= 0.5 & p_b == "b") %>%
  select(participant_id, acc) %>%
  mutate(reason = "fa_accuracy") %>%
  bind_rows(., excluded_participants)
```

## 4.5 Missing data
Participants who have 5 or more missing responses for the False Belief task will be excluded.
```{r}
excluded_participants <- DF.fa %>%
  dplyr::group_by(participant_id) %>%
  dplyr::summarise(missing = sum(is.na(fa_resp)))%>%
  filter(missing >= 5) %>%
  select(participant_id, missing) %>%
  mutate(reason = "fa_missing") %>%
  bind_rows(., excluded_participants)
```

Participants who do not finish the task. The false belief task is either after the IDAQ and rating task or before the IDAQ. 

Note: this is no longer needed (see section 2.1).
```{r}
idaq_sub <- DF.idaq %>% select(participant_id) %>% unique() 
fa_sub <- DF.fa %>% select(participant_id) %>% unique()

excluded_participants <- anti_join(idaq_sub, fa_sub, by = "participant_id") %>%  
  mutate(reason = "incomplete") %>%
  bind_rows(., excluded_participants)
```

## 4.6 Excluded participants
```{r}
excluded_participants %>%
  dplyr::group_by(reason) %>% 
  tally() %>% 
  knitr::kable(., "html", caption = "Excluded participants") %>%
  kable_styling("striped")
```

## 4.5 Update all the tasks 
```{r}
DF.demo <- DF.demo %>% filter(!participant_id %in% excluded_participants$participant_id)
DF.rating <- DF.rating %>% filter(!participant_id %in% excluded_participants$participant_id)
DF.prediction <- DF.prediction %>% filter(!participant_id %in% excluded_participants$participant_id)
DF.seen <- DF.seen %>% filter(!participant_id %in% excluded_participants$participant_id)
DF.fa <- DF.fa %>% filter(!participant_id %in% excluded_participants$participant_id) 
DF.idaq <- DF.idaq %>% filter(!participant_id %in% excluded_participants$participant_id)
```

# 5. Indices {.tabset .tabset-fade .tabset-pills}
For the main analyses we create situational and dispositional anthropomorphism and Theory-of-Mind indices.

## 5.1 Situational anthropomorphism and effectance ratings

The 5 anthropomorphism items will be averaged to create a situational anthropomorphism score and the 2 effectance items will be averaged to create an effectance score score (Waytz, Morewedge, et al., 2010). 

Visualise if situational anthropomorphism and effectance ratings fluctuate over time, event, and focus
```{r, echo=FALSE, warning=FALSE}
DF.mean <- DF.rating %>% 
  mutate(event_nr = factor(eventnr, levels=c(1:16), ordered=TRUE)) %>% 
  dplyr::group_by(event_nr, measure) %>%
  dplyr::summarise(rating = mean(response)) 

#DF.mean <- summarySEwithin(DF.rating, measurevar="response", withinvars= c("measure", "eventnr"), #idvar="participant_id")

#DF.mean$l <- DF.mean$response - DF.mean$ci
#DF.mean$h <- DF.mean$response + DF.mean$ci

p1 <- DF.rating %>%
  mutate(event_nr = factor(eventnr, levels=c(1:16), ordered=TRUE)) %>% 
  dplyr::group_by(participant_id, event_nr, measure) %>% #focus and event_type are included or excluded based on visualisation
  dplyr::summarise(rating = mean(as.numeric(response))) %>% 
  ggplot(., aes(event_nr, rating)) +
  geom_line(aes(group = participant_id), alpha=0.2) +
  geom_line(data = DF.mean, aes(group = 1), size = 1, color = 'red') +
  coord_fixed(ratio = 1/1) +
  facet_wrap(~measure) +
  scale_x_discrete(name ="event number") +
  scale_y_continuous(name="rating (1-7)", limits=c(1, 7), breaks=c(1:7))

ggsave("experiment2/figures/1A.TIFF", plot = p1, width = 24.7, height = 5.08, units = "cm", dpi = 300)

```

```{r, echo=FALSE, warning=FALSE}
DF.mean <- summarySEwithin(DF.rating, measurevar="response", withinvars= c("event_type", "focus","measure"), idvar="participant_id")

p2 <- DF.rating %>%
  dplyr::group_by(participant_id, event_type, focus, measure) %>% #focus and event_type are included or excluded based on visualisation
  dplyr::summarise(rating = mean(as.numeric(response))) %>% 
  ggplot(.,aes(x = event_type, y=rating, fill = focus))+
  geom_flat_violin(position=position_nudge(x = .2, y = 0),adjust =2, trim = FALSE, alpha = .75, colour = "Black") +
  geom_point(position=position_jitter(width = .05), size = .8, shape = 21, colour = "Black") +
  geom_boxplot(aes(x=event_type,y=rating),position=position_nudge(x = .12, y = 0),outlier.shape = NA, alpha = .5, width = .1, colour = "black") + 
  geom_point(data = DF.mean, aes(x = event_type, y = response), position = position_nudge(.3), colour = "BLACK")+
  geom_errorbar(data = DF.mean, aes(x=event_type,y=response, ymin = response-ci, ymax = response+ci), position=position_nudge(x = .3, y = 0), width = .05)+
  scale_fill_manual(values=c("#0072B2", "#D55E00")) +
  ylab(paste("Rating (1-7)")) + 
  facet_wrap(~measure) +
  scale_x_discrete(name ="event type") +
  scale_y_continuous(name="rating (1-7)", limits=c(1, 7), breaks=c(1:7))

ggsave("experiment2/figures/1As.TIFF", plot = p2, width = 18, height = 5.08, units = "cm", dpi = 300)

```

```{r, echo=FALSE}
p1 
p2
```

```{r}
DF.rating <- DF.rating %>% 
  dplyr::group_by(participant_id, measure) %>% #focus and event_type are included or excluded based on visualisation
  dplyr::summarise(rating = mean(as.numeric(response)))  
```

## 5.2	Dispositional anthropomorphism:
Check the reliability of the IDAQ scale:
```{r, eval = FALSE}
DF.idaq %>% 
  filter(!is.na(idaq_resp) & Scale == "IDAQ") %>%
  select(-Scale,-Question, -idaq_rt)  %>%
  pivot_wider(names_from = ItemNr, values_from = idaq_resp) %>%
  select(-participant_id) %>%
  psych::alpha(na.rm = TRUE) 
```

Check the reliability of the IDAQ-NA scale:
```{r, eval = FALSE}
DF.idaq %>% 
  filter(!is.na(idaq_resp) & Scale == "IDAQNA") %>%
  select(-Scale,-Question, -idaq_rt)  %>%
  pivot_wider(names_from = ItemNr, values_from = idaq_resp) %>%
  select(-participant_id) %>%
  psych::alpha(na.rm = TRUE)
```

We will sum the responses for the IDAQ and IDAQ-NA scale separately (Waytz, Cacioppo, et al., 2010). 
```{r}
DF.idaq <- DF.idaq %>%
  filter(!is.na(idaq_resp)) %>% 
  dplyr::group_by(participant_id, Scale) %>%
  dplyr::summarise(score = sum(idaq_resp)) 

DF.idaq %>%
  dplyr::group_by(Scale) %>%
  dplyr::summarise(median = median(score),
            iqr = IQR(score))
```

Visualise the IDAQ scores
```{r, echo=FALSE}
theme_set(theme_classic(base_size = 20)) 

DF.mean <- summarySEwithin(DF.idaq, measurevar="score", withinvars= "Scale", idvar="participant_id")
 
p3 <- DF.idaq %>%
  filter(Scale == "IDAQ") %>%
  dplyr::group_by(participant_id) %>%
  ggplot(.,aes(x = 1, y=score, fill = "Black"))+
  geom_flat_violin(position=position_nudge(x = .2, y = 0),adjust =2, trim = FALSE, alpha = .75, colour = "Black") +
  geom_point(position=position_jitter(width = .05), size = .5, shape = 21, colour = "Black") +
  geom_boxplot(aes(x=1,y=score),position=position_nudge(x = .12, y = 0),outlier.shape = NA, alpha = .5, width = .1, colour = "black") + 
  geom_point(data = DF.mean %>% filter(Scale == "IDAQ"), aes(x = 0.95, y = score), position = position_nudge(.3), colour = "BLACK")+
  geom_errorbar(data = DF.mean %>% filter(Scale == "IDAQ"), aes(x=0.95,y=score, ymin = score-ci, ymax = score+ci), position=position_nudge(x = .3, y = 0), width = .05)+
  scale_fill_brewer(palette = "Greys") +
  scale_colour_brewer(palette = "Greys") +
  coord_fixed(ratio = 1/90) + 
  ylab(paste("Dispositional anthropomorphism")) + 
  theme(legend.position="none") +
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  )
p3
ggsave("experiment2/figures/1B.TIFF", plot = p3, width = 24.7, height = 12, units = "cm", dpi = 300)

```

## 5.3	False belief
Accuracy (percentage correct) for the false-belief and false-photograph stories will be calculated separately (Spunt et al., 2015).

```{r}
DF.fa <- DF.fa %>% 
  dplyr::group_by(participant_id, p_b) %>%
  dplyr::summarise(acc = mean(acc, na.rm = TRUE)) #na.rm was missing
```

```{r, echo=FALSE}
DF.mean <- summarySEwithin(DF.fa, measurevar="acc", withinvars= "p_b", idvar="participant_id")
 
p4 <- DF.fa %>%
  ggplot(.,aes(x = p_b, y=acc, fill= p_b))+
  geom_flat_violin(position=position_nudge(x = .2, y = 0),adjust =2, trim = TRUE, alpha = .75, colour = "Black") +
  geom_point(position=position_jitter(width = .05), size = .5, shape = 21, colour = "Black") +
  geom_boxplot(aes(x=p_b,y=acc),position=position_nudge(x = .12, y = 0),outlier.shape = NA, alpha = .5, width = .1, colour = "black") + 
  geom_point(data = DF.mean, aes(x = p_b, y = acc), position = position_nudge(.3), colour = "BLACK")+
  geom_errorbar(data = DF.mean, aes(x=p_b,y=acc, ymin = acc-ci, ymax = acc+ci), position=position_nudge(x = .3, y = 0), width = .05)+
  ylim(0, 1.3) + 
  scale_fill_manual(values=c("#0072B2", "#D55E00")) +
  ylab("accuracy (p)")+
  xlab("belief (b) or photograph (p)") +
  theme(legend.position="none") 
p4 
```
Plot for MS without .5 exclusion criteria (don't run 4.4):
```{r}
DF.mean <- summarySEwithin(DF.fa, measurevar="acc", withinvars= "p_b", idvar="participant_id") %>% 
  filter(p_b == "b") 
theme_set(theme_classic(base_size = 20)) 

p4b <- DF.fa %>%
  filter(p_b == "b") %>%
  ggplot(.,aes(x = 1, y=acc, fill = "Black"))+
  geom_flat_violin(position=position_nudge(x = .2, y = 0),adjust =2, trim = TRUE, alpha = .75, colour = "Black") +
  geom_point(position=position_jitter(width = .05), size = .5, shape = 21, colour = "Black") +
  geom_boxplot(aes(x=1,y=acc),position=position_nudge(x = .12, y = 0),outlier.shape = NA, alpha = .5, width = .1, colour = "black") + 
  geom_point(data = DF.mean, aes(x = 1, y = acc), position = position_nudge(.3), colour = "BLACK")+
  geom_errorbar(data = DF.mean, aes(x=1,y=acc, ymin = acc-ci, ymax = acc+ci), position=position_nudge(x = .3, y = 0), width = .05)+
  #ylim(0, 1.3) + 
  scale_fill_brewer(palette = "Blues") +
  scale_colour_brewer(palette = "Blues") +
  ylab("accuracy on false belief trials (p)")+
  scale_y_continuous(name="Accuracy on false belief trials", limits=c(0, 1.1), breaks=c(0, 0.25, 0.5, 0.75, 1)) +
  theme(legend.position="none") +
  coord_fixed(ratio = 1/1) + 
  #ylim(0,1.1) +
  geom_hline(yintercept = 0.5, color = "grey", linetype = 2) + 
  theme(legend.position="none") +
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  )
p4b
ggsave("experiment2/figures/1C.TIFF", plot = p4b, width = 24.7, height = 12, units = "cm", dpi = 300)

```


## 5.4 One dataset with centered and scaled variables
```{r}
DF.exp2 <- DF.rating %>% 
  left_join(DF.idaq, by = "participant_id") %>% 
  left_join(DF.fa, by = "participant_id") %>% 
  left_join(DF.seen, by = "participant_id") %>% 
  left_join(DF.prediction, by = "participant_id") %>% 
  filter(Scale == "IDAQ" & p_b == "b") %>% 
  pivot_wider(names_from = measure, values_from = rating) %>% 
  ungroup() %>% 
  mutate(cent_sitant = scale(anthropomorphism, scale = TRUE)) %>% 
  mutate(cent_effectance = scale(effectance, scale = TRUE)) %>% 
  mutate(cent_disant = scale(score, scale = TRUE)) %>% 
  mutate(cent_falsebelief = scale(acc, scale = TRUE)) %>% 
  select(-score, - acc, -Scale, -p_b, -anthropomorphism, -effectance)
```

## 5.4 Visualise relationship between anthropomorphism indices

Visualise if dispositional anthropomorphism is positively related to situational anthropomorphism:
```{r}
p5 <- DF.exp2 %>%
  ggplot(aes(x=cent_sitant, y=cent_disant)) +
  geom_point(alpha=0.5,show.legend = FALSE) +
  geom_smooth(method="lm", formula=y ~ x, se=TRUE, show.legend = FALSE, colour="#0072B2") +
  geom_smooth(method="lm", formula=y ~ x+ I(x^2), se=TRUE, show.legend=FALSE, colour = "#D55E00") +
  coord_fixed(ratio = 1/1) +
  labs(
    x="Situational anthropomorphism",
    y="Dispositional anthropomorphism")
p5

cor.test(DF.exp2$cent_sitant, DF.exp2$cent_disant)
```
## 5.4 Visualise relationship between Theory-of-Mind indices

Visualise if false belief performance is positively related to effectance ratings:
```{r}
p6 <- DF.exp2 %>%
  ggplot(aes(x=cent_falsebelief, y=cent_effectance)) +
  geom_point(alpha=0.5,show.legend = FALSE) +
  geom_smooth(method="lm", formula=y ~ x, se=TRUE, show.legend = FALSE, colour="#0072B2") +
  geom_smooth(method="lm", formula=y ~ x+ I(x^2), se=TRUE, show.legend=FALSE, colour = "#D55E00") +
  coord_fixed(ratio = 1/1) +
  labs(
    x="False Belief",
    y="Effectance")
p6

cor.test(DF.exp2$cent_falsebelief, DF.exp2$cent_effectance)
write.csv(DF.exp2, "exp2.csv")
```

# 6. Analyses {.tabset .tabset-fade .tabset-pills}

Bayesian regression will be used to test a linear and non-linear (c.f. quadratic) relationship between situational and dispositional anthropomorphism and Theory-of-Mind.

## 6.1 Quadriatic predictors

For the formal analysis we will test a linear and quadratic relationship:
```{r}
DF.exp2$cent_disant2 <- DF.exp2$cent_disant^2
DF.exp2$cent_sitant2 <- DF.exp2$cent_sitant^2
```

## 6.2 Visualise the relationship

```{r, echo=FALSE}
p7 <- DF.exp2 %>%
  dplyr::rename(situational = cent_sitant, dispositional = cent_disant) %>% 
  pivot_longer(cols = c(situational, dispositional), names_to = "measure",  values_to = "value") %>%
  mutate(measure = fct_relevel(measure, c("situational", "dispositional"))) %>% 
  ggplot(aes(x=value, y=cent_effectance)) +
  geom_point(alpha=0.5,show.legend = FALSE) +
  geom_smooth(method="lm", formula=y ~ x, se=TRUE, show.legend = FALSE, colour="#0072B2") +
  geom_smooth(method="lm", formula=y ~ x+ I(x^2), se=TRUE, show.legend=FALSE, colour = "#D55E00") +
  coord_fixed(ratio = 1/1) +
  labs(
    x="Anthropomorphism",
    y="Effectance") +
  facet_wrap(~measure)

p8 <- DF.exp2 %>%
  dplyr::rename(situational = cent_sitant, dispositional = cent_disant) %>% 
  pivot_longer(cols = c(situational, dispositional), names_to = "measure",  values_to = "value") %>%   mutate(measure = fct_relevel(measure, c("situational", "dispositional"))) %>% 
  ggplot(aes(x=value, y=cent_falsebelief)) +
  geom_point(alpha=0.5,show.legend = FALSE) +
  geom_smooth(method="lm", formula=y ~ x, se=TRUE, show.legend = FALSE, colour="#0072B2") +
  geom_smooth(method="lm", formula=y ~ x+ I(x^2), se=TRUE, show.legend=FALSE, colour = "#D55E00") +
  coord_fixed(ratio = 1/1) +
  labs(
    x="Anthropomorphism",
    y="False belief accuracy") +
  facet_wrap(~measure)


p7 | p8
ggsave("experiment2/figures/1Da.TIFF", plot = p7, width = 24.7, height = 5.08, units = "cm", dpi = 300)
ggsave("experiment2/figures/1Db.TIFF", plot = p8, width = 24.7, height = 5.08, units = "cm", dpi = 300)


```

## 6.3 Set Priors
The models will be run with weakly-informative priors, which avoids inappropriate inferences that can be the result when using non-informative priors without supplying strict information (Gelman, Jakulin, Pittau, & Su, 2008). 
```{r}
priors1 <- c(set_prior("normal(0,1)", class = "b"),
             set_prior("student_t(3, -0.1, 2.5)", class = "Intercept"))
```

## 6.4 Visualise data for distribution
```{r, echo=FALSE}
p9 <- DF.exp2 %>%
  pivot_longer(cols = c("cent_effectance", "cent_falsebelief"), names_to = "dv") %>%
  ggplot(.) +
  geom_density(aes(x=value, group = dv, fill = dv), alpha = .1)
p9
```

## 6.5 Specify the formula and family for the models
Family will be updated based on the distribution of the data

Formula and family for effectance:
```{r}
bf_ef <- bf(cent_effectance ~ 1 + cent_sitant + cent_sitant2 + cent_disant + cent_disant2) +
   skew_normal()
```

Formula and family for false belief:
```{r}
bf_fb <- bf(cent_falsebelief ~ 1 + cent_sitant + cent_sitant2 + cent_disant + cent_disant2) +
  skew_normal()
```

## 6.6 Run full multivariate model
Test the relationship between situational and dispositional anthropomorphism and effectance, and false belief:
```{r}
model_f <- brm(bf_ef + bf_fb, 
                          data = DF.exp2,
                          prior = priors1,
                          chains = 4,
                          iter = 4000,
                          seed = 42, 
                          file = "experiment2/models/model_f.RDS")  
```

Get the summary:
```{r}
summary(model_f)
```

# 7. Posterior distribution {.tabset .tabset-fade .tabset-pills}

## 7.1 Tab models:
Use sjPlot to create html tables following [procedure outlined here](https://strengejacke.github.io/sjPlot/articles/tab_bayes.html):
```{r}
tab_model(
  model_f,
  #show.se = TRUE, 
  pred.labels = c("Intercept", "linear situational", "quadratic situational", "linear dispositional", "quadratic dispositional"),
  dv.labels = c("effectance", "false belief"),
  show.obs=FALSE
)
```

## 7.2 Posterior plots:
Create plots based on [this tutorial](https://www.rensvandeschoot.com/tutorials/r-linear-regression-bayesian-using-brms/):
```{r}
tom_combined <- as_tibble(as.mcmc(model_f, combine_chains = TRUE)) %>% 
  pivot_longer(cols = ends_with(c("ant", "ant2")), names_to = "varAnthro") %>% 
  select(varAnthro, value) %>% 
  separate(varAnthro, c("dv", "predictor"), sep = "_cent_")
```

Plot the distributions:
```{r}
p10 <- tom_combined %>%
  mutate_at(vars(-value),as.factor) %>%
  ggplot(., aes(value, fill = predictor)) +
  geom_density(alpha = .5)+
  geom_vline(xintercept = 0, color = "black", linetype = 2) +
  ggtitle(paste("Posterior distributions for the Theory-of-Mind measures")) + 
  facet_wrap(~dv, ncol =1) +
  theme(strip.background = element_blank()) +
  scale_fill_manual(values=c("#0072B2", "#000033", "#D55E00", "#660000"))
p10
```

# 8. Model comparison {.tabset .tabset-fade .tabset-pills}

We will run several models following the predictions:
    
    1.	There will be a linear and positive relationship between situational anthropomorphism and Theory-of-Mind (model_s). 
    2.	There will be a quadratic relationship between dispositional anthropomorphism and Theory-of-Mind (model_d).
    3.	Situational anthropomorphism will be a better predictor of Theory-of-Mind than dispositional anthropomorphism (combined and full model and model comparison).

## 8.1 Incremental models
Function to run the models:
```{r}
comp_model <- function(name, model_formula1, model_formula2){
  
  bf_ef <- bf(model_formula1) +
   skew_normal()
  
  bf_fb <- bf(model_formula2) +
  skew_normal()
  
  brm(bf_ef + bf_fb, 
      data = DF.exp2,
      prior = priors1,
      chains = 4,
      iter = 4000,
      seed = 42, 
      file = paste0("experiment2/models/", name, ".RDS", sep = ""))
}
```

We start with the simple intercept-only model: 
```{r}
  bf_ef <- bf(cent_effectance ~ 1) +
   gaussian()
  
  bf_fb <- bf(cent_falsebelief ~ 1) +
  skew_normal()
  
model_i <- brm(bf_ef + bf_fb,
      data = DF.exp2,
      chains = 4,
      iter = 4000,
      seed = 42, 
      file = "experiment2/models/model_i.RDS")
```

Followed by a linear situational predictor model, and a quadratic dispositional predictor model, and a combined model:
```{r}
model_s <- comp_model("model_s", cent_effectance ~ cent_sitant, cent_falsebelief ~ cent_sitant) #prediction 1
model_d <- comp_model("model_d", cent_effectance ~ cent_disant2, cent_falsebelief ~ cent_disant2) #prediction 2
model_sd <- comp_model("model_sd", cent_effectance ~ cent_sitant + cent_disant2, cent_falsebelief ~ cent_sitant + cent_disant2) #prediction 3
```

## 8.2 Model comparison
Add LOO to models and compare the models (code adapted from Richard Ramsey):
```{r}
model_i <- add_criterion(model_i, "loo")
model_s <- add_criterion(model_s, "loo")
model_d <- add_criterion(model_d, "loo")
model_sd <- add_criterion(model_sd, "loo")
model_f <- add_criterion(model_f, "loo")

lmv <- loo_compare(model_i, model_s, model_d, model_sd, model_f, criterion = "loo") 

lmv %>% 
  knitr::kable(., "html", caption = "Model comparison") %>%
  kable_styling("striped")
```

Get the loo weights:
```{r}
model_weights(model_i, model_s, model_d, model_sd, model_f,
              weights = "loo") %>% 
  round(digits = 3) %>% 
  knitr::kable(., "html", caption = "Loo weights") %>%
  kable_styling("striped")
```

## 8.3 Plot

Tabulate and then plot:
```{r}
lmv_dat <- lmv %>%
  data.frame() %>% 
  rownames_to_column(var = "model")

p11 <-  ggplot(lmv_dat) +
  geom_pointrange(aes(x = reorder(model, -elpd_loo), y = elpd_loo,
                      ymin = elpd_loo - se_elpd_loo,
                      ymax = elpd_loo + se_elpd_loo,
                      color = model),
                  shape = 16) +
  coord_flip() +
  labs(x = "model", y = "elpd_loo",
       title = "Multivariate model comparison via Loo") +
  theme(legend.position = "none") + 
  scale_colour_brewer(palette = "Reds") 

  
p11
```


# 9. HDI+ROPE decision rule {.tabset .tabset-fade .tabset-pills}

## 9.1 Re-run models for rope

Multivariate models are not yet supported, so we will rerun the models one-by-one for effectance and false belief (full and winning model):

Full effectance model:
```{r}
modelef <- brm(formula = cent_effectance ~ cent_sitant + cent_sitant2 + cent_disant + cent_disant2, 
      data = DF.exp2,
      family = gaussian,
      prior = priors1,
      chains = 4,
      iter = 4000,
      seed = 42, 
      file = "experiment2/models/modelef.RDS")
```

Full false belief model:
```{r}
modelfb <- brm(formula = cent_falsebelief ~ cent_sitant + cent_sitant2 + cent_disant + cent_disant2, 
      data = DF.exp2,
      family = gaussian,
      prior = priors1,
      chains = 4,
      iter = 4000,
      seed = 42, 
      file = "experiment2/models/modelfb.RDS")
```

Code for winning models based on LOO outcome.

## 9.2 HDI+ROPE function

Create a function for HDI+ROPE: 
```{r}
hdi_rope <- function(model){
  rope <- rope_range(model)
  rope_model <- equivalence_test(model, range = rope, ci = 0.95) 
  plot(rope_model) + theme_classic() + 
    ggtitle(deparse(substitute(model))) + 
    theme(axis.title.y = element_blank(), axis.title.x = element_blank()) 
}
```

## 9.3 Full model effectance
```{r}
hdi_rope(modelef) 
```

## 9.4 Full  model false belief
```{r}
hdi_rope(modelfb) 
```

## 9.5 Winning  model effectance
```{r, eval = FALSE}
hdi_rope(modelef_winning) #change the name based on LOO (remove eval = FALSE)
```

## 9.5 Winning  model effectance
```{r, eval = FALSE}
hdi_rope(modelfb_winning) #change the name based on LOO (remove eval = FALSE)
```


## 9.6 Alternative figure using ggplot to show rope based on [http://mjskay.github.io/tidybayes/articles/tidy-brms.html#posterior-predictions-kruschke-style-1]
```{r}
combined_models <-
  bind_rows("modelef" = as_tibble(as.mcmc(modelef,
  pars = c("b_cent_sitant", "b_cent_sitant2", "b_cent_disant", "b_cent_disant2"),
  combine_chains = TRUE)),
  "modelfb" = as_tibble(as.mcmc(modelfb,
  pars = c("b_cent_sitant", "b_cent_sitant2", "b_cent_disant", "b_cent_disant2"),
  combine_chains = TRUE)),
  .id = "model")

modelnames <- list('modelef'="effectance",'modelfb'="false belief")
model_labeller <- function(variable,value){
  return(modelnames[value])
}

colours2 <- c(
  "Reject"="green3",
  "Undecided"="gold",
  "Accept"="red2"
)

combined_models3 %>%
  pivot_longer(c("b_cent_sitant", "b_cent_sitant2", "b_cent_disant", "b_cent_disant2"),names_to = "var_anth") %>%
  mutate(Decision= ifelse(model=="modelef"&var_anth=="b_cent_sitant", "Reject",
                          ifelse(var_anth=="b_cent_disant"|model=="modelfb"&var_anth=="b_cent_sitant","Undecided", 
                          ifelse(model=="modelfb"&var_anth=="b_cent_sitant2", "Undecided",
                          ifelse(model=="modelfb"&var_anth=="b_cent_disant2", "Accept",
                          ifelse(model=="modelef"&var_anth=="b_cent_disant2"|model=="modelef"&var_anth=="b_cent_sitant2", "Accept", "NA"))))))%>%
  group_by("Decision")%>%
  ggplot(aes(y = var_anth, x = value,fill=Decision)) +
  stat_halfeye(alpha=0.5) +
  scale_y_discrete(labels=c("b_cent_sitant"="situational linear","b_cent_sitant2"="situational quadratic","b_cent_disant"="dispositional linear","b_cent_disant2"="dispositional quadratic")) +
  geom_vline(xintercept = c(-.1, .1), linetype = "dashed") +
  labs(y = "Model", x="") +
  scale_fill_manual(values=colours2)+
  facet_wrap(~model,labeller = model_labeller)
```


```{r}
sessionInfo()
```