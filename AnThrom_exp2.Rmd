---
output:
  html_notebook:
    number_sections: no
    theme: default
    toc: yes
    toc_float: yes
  html_document:
    df_print: paged
    toc: yes
editor_options: 
  chunk_output_type: inline
---
#**AnThroM**
**Experiment 2: testing the relation between situationa and dispositional anthropomorphism and Theory-of-Mind**  
by *Ruud Hortensius and Michaela Kent (University of Glasgow) - June 2020 - ...*

# 1. Details {.tabset}

## 1.1 Preregistration
The preregistration can be found here:

## 1.2 Data description
[short description]


## 1.3 Libraries
```{r}
library(fs)
library(psych)
library(patchwork)
library(tidyverse)
source("R_rainclouds.R") #/Volumes/Project0255/code
#source("summarySE.R")
theme_set(theme_classic(base_size = 20)) 
```

# 2. Rating task {.tabset}

## 2.1 Events for the movie
```{r}
events <- read_csv("/Users/ruudhortensius/PsyCloud/Technician/1_AnThrom/Experiment_2/task/pilot/events_pilot.csv")
events_cloud = c(4,5,14)
```

## 2.2 Rating data for the movie
Explain it:
```{r}
DF.rating <- dir_ls(paste("/Users/ruudhortensius/PsyCloud/Technician/1_AnThrom/Experiment_2/data/pilot"), regexp = "\\.csv$") %>% 
  map_dfr(read_csv, .id = "id") %>%
  select("please type in a series of digits", "eventnr", "event_type",  "measure", "item", "focus", "key_resp_1.keys", "key_resp_2.keys", "slider.response")  %>%
  rename_at(1,~"sub",3) %>%
  mutate_at(vars(-key_resp_1.keys, -key_resp_2.keys, -slider.response),as.factor) %>%
  mutate(response = coalesce(key_resp_1.keys, key_resp_2.keys, slider.response)) %>%
  select(sub, measure, item, focus, response) %>%
  filter(!is.na(response) & !is.na(focus)) %>%
  group_by(sub) %>%
  mutate(trial_nr = c(1:length(response))) %>%
  left_join(., events, by = "trial_nr")
```

## 2.3 Visualise

```{r}
DF.rating %>%
  filter(event_nr != "end") %>%
  group_by(sub, measure, event_type) %>%
  summarise(rating = mean(response)) %>%
  ggplot(., aes(x=event_type, y=rating, fill = event_type)) +
  geom_point(aes(colour = event_type), position=position_jitter(width = .05), size = 5, shape = 21, colour = "Black") +
  geom_flat_violin(position=position_nudge(x = .2, y = 0),adjust =2, trim = FALSE, alpha = .75, colour = "Black") +
  geom_boxplot(aes(x=event_type,y=rating),position=position_nudge(x = .1, y = 0),outlier.shape = NA, alpha = .5, width = .1, colour = "black") +
  ylab("rating")+
  xlab("mental or pain") +
  scale_fill_manual(values=c("#0072B2", "#D55E00")) +
  theme(legend.position="none") +
  facet_wrap(~measure)
```


# 3. False belief task {.tabset}

## 3.1 Load the correct answers

```{r}
fa_ca <- read_csv("/Users/ruudhortensius/PsyCloud/Technician/1_AnThrom/Experiment_2/task/false_belief_correct_answers.csv")  %>%
  select("item_number", "CA") 
```


## 3.1 Load the data

```{r}
DF.fa <- dir_ls(paste("/Users/ruudhortensius/PsyCloud/Technician/1_AnThrom/Experiment_2/data/pilot"), regexp = "\\.csv$") %>% 
  map_dfr(read_csv, .id = "id") %>%
  select("please type in a series of digits", "p_b", "trials_fb.thisIndex",  "key_resp_fb.keys")  %>%
  rename_at(1,~"sub",3) %>%
  rename(fa_resp = key_resp_fb.keys, item_number = trials_fb.thisIndex) %>%
  mutate_at(vars(),as.factor) %>%
  filter(!is.na(fa_resp)) %>%
  left_join(., fa_ca, by = "item_number") %>%
  mutate(acc = ifelse(fa_resp == CA, 1, 0)) %>%
  group_by(sub, p_b) %>%
  summarise(acc = mean(acc)) %>%
  ungroup()%>%
  mutate_at(vars(-acc), as.factor)
```

## 3.2 Plot the data:

```{r}
DF.fa %>%
  ggplot(., aes(x=p_b, y=acc, fill = p_b)) +
  geom_point(aes(colour = p_b), position=position_jitter(width = .05), size = 5, shape = 21, colour = "Black") +
  geom_flat_violin(position=position_nudge(x = .2, y = 0),adjust =2, trim = FALSE, alpha = .75, colour = "Black") +
  geom_boxplot(aes(x=p_b,y=acc),position=position_nudge(x = .1, y = 0),outlier.shape = NA, alpha = .5, width = .1, colour = "black") +
  ylab("accuracy (p)")+
  xlab("belief (b) or photograph (p)") +
  scale_fill_manual(values=c("#0072B2", "#D55E00")) +
  theme(legend.position="none")
```




# 5. IDAQ {.tabset}

## 5.1 Calculation of individual scores:

Get the IDAQ data for all the participants:
```{r}
#load data (/Volumes/Project0255/dataset_1/sourcedata/)
DF.idaq  <- read_csv(file = "IDAQ_dataset1.csv") %>%
  gather("sub", "value", 4:32)
```


## 5.2 Reliability of IDAQ
Check the reliability of the IDAQ scale:
```{r}
DF.idaq %>% 
  filter(scale == "IDAQ") %>%
  #filter(!sub %in% sub_ex) %>% 
  select(-scale, -subscale)  %>%
  spread(itemnr, value) %>%
  select(-sub) %>%
  alpha(na.rm = TRUE)
```

## 5.3 Reliability of IDAQ-NA
Check the reliability of the IDAQ-NA scale:
```{r}
DF.idaq %>% 
  filter(scale == "IDAQNA") %>%
  filter(!sub %in%  sub_ex) %>% 
  select(-scale, -subscale)  %>%
  spread(itemnr, value) %>%
  select(-sub) %>%
  alpha(na.rm = TRUE)
```

## 5.4 IDAQ per subject
Calculate the IDAQ per subject:
```{r}
DF.idaq <- DF.idaq %>%
  group_by(sub, scale) %>%
  summarise(score = sum(value, na.rm = TRUE)) %>%
  ungroup()%>%
  mutate_at(vars(-score),as.factor)
```

## 5.5 Visualise the scores
Visualise the scores across the datasets and scales:
```{r}
#idaq_sum <- summarySEwithin(DF.idaq, measurevar="score", betweenvars="dataset", withinvars= "scale", idvar="sub")

p <- DF.idaq %>%
  group_by(sub, scale) %>%
  filter(scale == "IDAQ") %>%
  ggplot(.,aes(x=scale,y=score,fill=scale, group = scale))+
  geom_flat_violin(position=position_nudge(x = .2, y = 0),adjust =2, trim = FALSE, alpha = .75, colour = "Black") +
  geom_point(aes(colour = scale), position=position_jitter(width = .05), size = .5, shape = 21, colour = "Black") +
  geom_boxplot(aes(x=scale,y=score),position=position_nudge(x = .1, y = 0),outlier.shape = NA, alpha = .5, width = .1, colour = "black") + 
  #geom_errorbar(data = idaq_sum, aes(x=scale,y=score, ymin = score-ci, ymax = score+ci), position=position_nudge(x = .3, y = 0), width = .05)+
  scale_fill_brewer(palette = "Blues") +
  scale_colour_brewer(palette = "Blues") +
  theme_classic() + 
  ylab(paste("score (0-150)")) + 
  ggtitle(paste("IDAQ scores across scales")) +
  theme(legend.position="none") 
p
```

## 5.6 Median and interquartile range 
Calculate the median IQR per dataset (table S2):
```{r}
DF.idaq %>%
  #filter(!sub %in%  sub_ex) %>% 
  group_by(sub, scale) %>%
  summarise(score = sum(score)) %>%
  group_by(scale) %>%
  summarise(median = median(score),
            iqr = IQR(score))
```

# 6. Combine Data and Transformations {.tabset}


## 6.1 Combine IDAQ scores and ROI data:
Create one DF:
```{r}
DF.roi <- DF.idaq %>% 
  group_by(sub,dataset, scale) %>%
  ungroup() %>% 
  left_join(DF.roi, DF.idaq, by = c("sub","dataset"), keep = FALSE) %>%
  pivot_wider(names_from=scale, values_from = score) #
```

## 6.2 Combine IDAQ scores and ROI data:
Center the variables for the formal analysis:
```{r}
DF.roi$cent_IDAQNA <- scale(DF.roi$IDAQNA, scale = TRUE)
DF.roi$cent_IDAQ <- scale(DF.roi$IDAQ, scale = TRUE)
DF.roi <- DF.roi %>% group_by(roi) %>% mutate(cent_contrast = scale(contrast, scale =TRUE)) #scale per roi (analyses are done per roi)
```

## 6.3 Create a quadratic predictor:

For the formal analysis we will test a linear and quadratic relationship between anthropomorphism and ToM :
```{r}
DF.roi$cent_IDAQ2 <- DF.roi$cent_IDAQ^2
```

# 7. IDAQ scores and ToM activity {.tabset}

## 7.1 Plot ToM and IDAQ
Create scatterplots with linear and non-linear lines: 
```{r}
p1 <- DF.roi %>%
  filter(network == "tom") %>%
  ggplot(aes(x=cent_IDAQ, y=cent_contrast)) +
  geom_point(alpha=0.5,show.legend = FALSE) +
  geom_smooth(method="lm", formula=y ~ x, se=TRUE, show.legend = FALSE, colour="#0072B2") +
  geom_smooth(method="lm", formula=y ~ x+ I(x^2), se=TRUE, show.legend=FALSE, colour = "#D55E00") +
  coord_fixed(ratio = 1/1) +
  labs(
    x="IDAQ score",
    y="contrast (mental vs pain)"
  ) + theme_classic()

p2 <- DF.roi %>%
  filter(network == "tom") %>%
  ggplot(aes(x=cent_IDAQ, y=cent_contrast)) +
  geom_point(alpha=0.5,show.legend = FALSE) +
  geom_smooth(method="lm", formula=y ~ x, se=TRUE, show.legend = FALSE, colour="#0072B2") +
  geom_smooth(method="lm", formula=y ~ x+ I(x^2), se=TRUE, show.legend=FALSE, colour = "#D55E00") +
  coord_fixed(ratio = 1/1) +
  labs(
    x="IDAQ score",
    y="contrast (mental vs pain)"
  ) + theme_classic() +
  facet_wrap(~roi)

p1 + p2
```

## 7.2 ToM regression models:
We run the models with uninformative (default) priors and create a function to run it for each region separately:
```{r}
reg_model <- function(region){
  brm(formula = cent_contrast ~ cent_IDAQ + cent_IDAQ2,
      data = DF.roi %>% filter(roi == region),
      family = gaussian,
      chains = 4,
      iter = 4000,
      seed = 42, #so the model is reproducible
      file = paste0(region, ".RDS"))
}
```

## 7.3
Create plots (different way):
```{r}
tom_combined <- bind_rows("rtpj" = as_tibble(as.mcmc(rtpj,  pars = c("b_cent_IDAQ", "b_cent_IDAQ2"), combine_chains = TRUE)),
                          "ltpj" = as_tibble(as.mcmc(ltpj, pars = c("b_cent_IDAQ", "b_cent_IDAQ2"),combine_chains = TRUE)),
                          "prec" = as_tibble(as.mcmc(prec, pars = c("b_cent_IDAQ", "b_cent_IDAQ2"),combine_chains = TRUE)),
                          "vmpfc" = as_tibble(as.mcmc(vmpfc, pars = c("b_cent_IDAQ", "b_cent_IDAQ2"),combine_chains = TRUE)),
                          "mmpfc" = as_tibble(as.mcmc(mmpfc, pars = c("b_cent_IDAQ", "b_cent_IDAQ2"),combine_chains = TRUE)),
                          "dmpfc" = as_tibble(as.mcmc(dmpfc, pars = c("b_cent_IDAQ", "b_cent_IDAQ2"),combine_chains = TRUE)),
                          .id = "roi")

tom_combined <- tom_combined %>%
  pivot_longer(c("b_cent_IDAQ", "b_cent_IDAQ2"),names_to = "varIDAQ") %>%
  mutate(roi = fct_relevel(roi, order[1:6]))
```

Plot the distributions:
```{r}
ggplot(data = tom_combined, aes(value, fill = varIDAQ)) +
  geom_density(alpha = .5)+
  geom_vline(xintercept = 0, color = "black", linetype = 2) +
  ggtitle(paste("Posterior distributions for the Theory-of-Mind network")) + 
  facet_wrap(~roi, ncol =1) +
  coord_fixed(ratio = 1/40) +
  theme_classic(base_size = 8) +
  theme(strip.background = element_blank()) +
  scale_fill_manual(values=c("#0072B2", "#D55E00"))+ 
  theme(axis.text.y = element_blank())
```


Get the summaries (do some wrangling):
```{r}
# load required packages
library(devtools)
library(sjPlot)
library(insight)
library(httr)

rtpj <- tab_model(rtpj)
ltpj <- tab_model(ltpj)
prec <- tab_model(prec)
vmpfc <- tab_model(vmpfc)
mmpfc <- tab_model(mmpfc)
dmpfc <- tab_model(dmpfc)
tab_model(rtpj,ltpj,prec,vmpfc,mmpfc,dmpfc, show.obs=FALSE, show.aic = TRUE)

